// Core Config
let config;
let client;
const WALLETCONNECT_PROJECT_ID = 'c0aa1ca206eb7d58226102b102ec49e9';

// Base chain config
const base = {
  id: 8453,
  name: 'Base',
  network: 'base',
  nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
  rpcUrls: {
    default: { http: ['https://mainnet.base.org'] },
    public: { http: ['https://mainnet.base.org'] }
  },
  blockExplorers: {
    default: { name: 'Basescan', url: 'https://basescan.org' }
  },
  contracts: {
    multicall3: {
      address: '0xcA11bde05977b3631167028862bE2a173976CA11',
      blockCreated: 8440150
    }
  }
};

const walletConnectConnector = typeof wagmi !== 'undefined' && typeof wagmi.connectors !== 'undefined'
  ? new wagmi.connectors.WalletConnectConnector({
    chains: [base],
    options: {
      projectId: WALLETCONNECT_PROJECT_ID,
      showQrModal: true
    }
  }) : null;

// Init logic
function initializeWagmi() {
  if (
    typeof wagmi === 'undefined' ||
    typeof wagmi.createClient !== 'function' ||
    typeof viem === 'undefined' ||
    typeof viem.createPublicClient !== 'function'
  ) {
    console.error("Libraries not loaded.");
    return;
  }

  config = wagmi.createClient({
    autoConnect: true,
    connectors: [
      walletConnectConnector,
      new wagmi.connectors.InjectedConnector({ chains: [base] })
    ].filter(Boolean),
    provider: ({ chainId }) =>
      viem.createPublicClient({
        chain: base,
        transport: viem.http()
      })
  });

  client = config;

  config.subscribe(state => {
    const isConnected = state.status === 'connected';
    const currentAddress = state.data?.account;
    document.getElementById('connectWallet').style.display = isConnected ? 'none' : 'inline-block';
    document.getElementById('disconnectWallet').style.display = isConnected ? 'inline-block' : 'none';
    document.getElementById('headerWalletAddress').textContent = currentAddress || 'Not Connected';
  });
}

function waitForWagmiAndViem(retry = 0) {
  if (
    typeof wagmi !== 'undefined' &&
    typeof wagmi.createClient === 'function' &&
    typeof viem !== 'undefined' &&
    typeof viem.createPublicClient === 'function'
  ) {
    initializeWagmi();
  } else if (retry < 10) {
    console.log("Waiting for wagmi and viem...");
    setTimeout(() => waitForWagmiAndViem(retry + 1), 300);
  } else {
    console.error("Timeout waiting for wagmi and viem.");
  }
}
waitForWagmiAndViem();

// Wallet Connect
async function connectWallet() {
  if (!config) {
    console.error("Wagmi config saknas.");
    return;
  }

  try {
    const { connector } = await config.connect({ connector: walletConnectConnector });
    const state = config.getState?.();
    console.log("âœ… Connected:", state?.data?.account);
  } catch (error) {
    console.error("Wallet Connection Error:", error);
  }
}

// Wallet Disconnect
async function disconnectWallet() {
  if (!config) {
    console.error("Wagmi config not initialized.");
    return;
  }

  try {
    await config.disconnect();
    console.log("ðŸ”Œ Wallet disconnected.");
    document.getElementById('headerWalletAddress').textContent = 'Not Connected';
    localStorage.clear();
  } catch (error) {
    console.error("Wallet Disconnection Error:", error);
  }
}

// UI Bind
window.addEventListener('DOMContentLoaded', () => {
  const connectWalletBtn = document.getElementById('connectWallet');
  const disconnectBtn = document.getElementById('disconnectWallet');

  if (connectWalletBtn) connectWalletBtn.addEventListener('click', connectWallet);
  if (disconnectBtn) disconnectBtn.addEventListener('click', disconnectWallet);
});

console.log("WarpAI v1 â€“ wagmi@1.3.6 / viem@1.14.2");
